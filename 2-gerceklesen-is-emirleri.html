<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>Kardemir - Gerçekleşen İş Emirleri</title>
  <link href="style.css" rel="stylesheet" />
  <style>
    :root {
      --border-color: #ddd;
      --main-bg-light: #f2f2f2;
      --text-color-dark: #333;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      table-layout: auto;
    }

    .data-table th,
    .data-table td {
      padding: 8px 10px;
      text-align: center;
      border-bottom: 1px solid var(--border-color, #ccc);
      font-size: 12px;
      word-wrap: break-word;
      white-space: normal;
    }

    .data-table thead th {
      background: var(--main-bg-light, #f2f2f2);
      font-weight: 700;
      color: var(--text-color-dark, #333);
      text-transform: uppercase;
      font-size: 12px;
    }

    .filters {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: flex-end;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 15px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
    }

    .field label {
      font-weight: bold;
      color: #444;
    }

    .field input {
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 13px;
    }

    .btn-filter {
      background: #1976d2;
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-filter:hover {
      background: #125a9c;
    }

    .detail-btn {
      background: #1976d2;
      color: #fff;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .detail-btn:hover {
      background: #125a9c;
    }

    /* Özet alanı (açılır/kapanır) */
    .summary-wrapper {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 6px;
      margin-bottom: 10px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, .08);
      overflow: hidden;
    }

    .summary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #42a5f5;
      color: #fff;
      padding: 6px 10px;
      font-size: 13px;
      border-bottom: 1px solid #ccc;
    }

    .toggle-btn {
      background: transparent;
      border: none;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      transition: transform .2s;
    }

    .toggle-btn.rotated {
      transform: rotate(180deg);
    }

    .collapsible {
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      transition: all .3s ease;
    }

    .collapsible.open {
      max-height: 800px;
      opacity: 1;
    }

    /* --- Summary chips & bars --- */
    .summary {
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: #fff;
      padding: 12px;
    }

    .summary .range {
      text-align: left;
      font-size: 12px;
      color: #555;
    }

    .chips {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .chip {
      display: flex;
      align-items: center;
      gap: 6px;
      background: #f5f7fa;
      border: 1px solid #ddd;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
    }

    .chip b {
      font-weight: 700;
      color: #111;
    }

    .bars {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
    }

    @media (max-width:1024px) {
      .bars {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width:640px) {
      .bars {
        grid-template-columns: 1fr;
      }
    }

    .bar-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      background: #fff;
    }

    .bar-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      margin-bottom: 6px;
    }

    .bar-title {
      font-weight: 700;
      color: #222;
    }

    .bar-value {
      font-weight: 700;
    }

    .bar {
      height: 8px;
      background: #e9eef5;
      border-radius: 999px;
      overflow: hidden;
    }

    .bar>span {
      display: block;
      height: 100%;
      background: linear-gradient(90deg, #1976d2, #42a5f5);
    }

    .table-button {
      display: inline-block;
      /* flex olmasına gerek yok */
      padding: 6px 14px;
      background-color: #42a5f5;
      /* mavi */
      color: white;
      border-radius: 5px;
      text-decoration: none;
      font-size: 11px;
      font-weight: 500;
      transition: 0.2s ease;

      white-space: normal;
      max-width: 120px;
      /* butona bir genişlik sınırı veriyoruz */
      text-align: center;
      /* ortalansın */
      word-break: break-word;
      /* gerekirse kelimeyi böler */
    }

    .table-button:hover {
      background-color: #303f9f;
    }
  </style>
</head>

<body>
  <!-- Sidebar -->
  <aside id="sidebar">
    <div id="sidebar-container"></div>
    <script>
      fetch("sidebar.html")
        .then(res => res.text())
        .then(data => document.getElementById("sidebar-container").innerHTML = data);
    </script>
  </aside>

  <div class="content-wrapper">
    <header class="header">
      <div class="breadcrumbs">
        <a href="#">Ana Sayfa</a> <span>&gt;</span>
        <span>Gerçekleşen İş Emirleri</span>
      </div>
    </header>

    <!-- Filtreler -->
    <div class="filters">
      <div class="field">
        <label>İş Emri No</label>
        <input type="text" id="fSiparis" placeholder="5000…">
      </div>
      <div class="field">
        <label>Malzeme No</label>
        <input type="text" id="fMalzeme" placeholder="8003…">
      </div>
      <div class="field">
        <label>Başlangıç</label>
        <input type="date" id="fStart">
      </div>
      <div class="field">
        <label>Bitiş</label>
        <input type="date" id="fEnd">
      </div>
      <button class="btn-filter" onclick="applyFilters()">Filtrele</button>
    </div>

    <!-- Özet / Trend -->
    <div class="summary-wrapper">
      <div class="summary-header">
        <h3>Özet / Trend Bilgileri</h3>
        <button id="toggleSummaryBtn" class="toggle-btn" onclick="toggleSummary()">▲</button>
      </div>
      <div id="summary" class="summary collapsible open">
        <div class="range" id="summary-range"></div>
        <div class="chips" id="summary-chips"></div>
        <div class="bars" id="summary-bars"></div>
      </div>
    </div>

    <!-- Tablo -->
    <div class="main-report-area">
      <h2 class="report-title">Gerçekleşen İş Emirleri</h2>
      <div style="overflow-x:auto; width:100%;">
        <table class="data-table" style="min-width:1800px;">
          <thead>
            <tr>
              <th>Detay</th>
              <th>Kayıt Tarihi</th>
              <th>İşyeri</th>
              <th>Malzeme</th>
              <th>Tanım</th>
              <th>İş Emri</th>
              <th>Şarj Miktarı</th>
              <th>Günlük Üretim</th>
              <th>1. Sınıf MI</th>
              <th>1. Sınıf Döküm</th>
              <th>1. Sınıfa Miktarı</th>
              <th>2. Sınıf MI</th>
              <th>2. Sınıf Miktarı</th>
              <th>Hold Miktarı</th>
              <th>Hadde Bozgun Miktarı</th>
              <th>Hurda Miktarı</th>
              <th>Mal Grubu</th>
              <th>Kalite</th>
              <th>Çap (mm)</th>
              <th>Döküm Tipi</th>
              <th>Planlanan Miktar</th>
              <th>Gerçekleşme Oranı</th>
              <!-- <th>Detay</th> -->
            </tr>
          </thead>
          <tbody id="detail-table-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    /* --- Mock veri (KHH) --- */
    const detailOrders = [
      { detay: "", tarih: "27.08.2025", isyeri: "KHH", malzeme: "80000025", tanim: "Ø14,00 B420C_00 12000 Nervürlü İnşaat Çeliği", siparis: "50000001591", sarjMiktar: "551,178", gunlukUretim: "526,664", birinciSinifMI: "520,214", birinciSinifDokum: "6,450", birinciSinifMiktar: "0", ikinciSinifMI: "0", ikinciSinifMiktar: "0", holdMiktar: "0", haddeBozgun: "9,558", hurdaMiktar: "0", malGrubu: "8100.001", kalite: "B420C_00", cap: "14,00", dokumTipi: "A", planlanan: "", gerceklestirme: "" },
      { tarih: "26.08.2025", isyeri: "KHH", malzeme: "80000025", tanim: "Ø14,00 B420C_00 12000 Nervürlü İnşaat Çeliği", siparis: "50000001591", sarjMiktar: "1.787,346", gunlukUretim: "1.813,997", birinciSinifMI: "1.795,482", birinciSinifDokum: "17,615", birinciSinifMiktar: "0", ikinciSinifMI: "0", ikinciSinifMiktar: "0", holdMiktar: "0", haddeBozgun: "14,337", hurdaMiktar: "0", malGrubu: "8100.001", kalite: "B420C_00", cap: "14,00", dokumTipi: "A", planlanan: "", gerceklestirme: "" },
      { tarih: "25.08.2025", isyeri: "KHH", malzeme: "80000025", tanim: "Ø14,00 B420C_00 12000 Nervürlü İnşaat Çeliği", siparis: "50000001591", sarjMiktar: "1.651,941", gunlukUretim: "1.629,969", birinciSinifMI: "1.612,906", birinciSinifDokum: "17,063", birinciSinifMiktar: "0", ikinciSinifMI: "0", ikinciSinifMiktar: "0", holdMiktar: "0", havdeBozgun: "30,267", hurdaMiktar: "0", malGrubu: "8100.001", kalite: "B420C_00", cap: "14,00", dokumTipi: "A", planlanan: "", gerceklestirme: "" }
    ].map(r => ({ ...r, haddeBozgun: r.haddeBozgun ?? r.havdeBozgun })); // olası yazım farkını normalize ettik

    /* --- Yardımcılar --- */
    function toFloat(str) {
      if (typeof str === "number") return str;
      if (!str) return 0;
      return parseFloat(String(str).replace(/\./g, '').replace(',', '.')) || 0;
    }
    function toISODateTR(dmy) { const [d, m, y] = dmy.split('.'); return `${y}-${m}-${d}`; }
    function formatTon(v) {
      const n = Math.round(v * 100) / 100;
      return n.toLocaleString('tr-TR', { minimumFractionDigits: 0, maximumFractionDigits: 2 }) + ' ton';
    }

    /* --- Tablo --- */
    function renderTable(data) {
      const tbody = document.getElementById("detail-table-body");
      tbody.innerHTML = "";
      data.forEach(order => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td><a href="1-2-yari-mamul-listesi.html" class="table-button">Yarı Mamul Listesine Git</a></td>
          <td>${order.tarih}</td>
          <td>${order.isyeri}</td>
          <td>${order.malzeme}</td>
          <td class="tanim">${order.tanim}</td>
          <td><a href="2-1-is-emri-detay.html?no=${order.siparis}" style="color:#1976d2;font-weight:600;text-decoration:none">${order.siparis}</a></td>
          <td>${order.sarjMiktar}</td>
          <td>${order.gunlukUretim}</td>
          <td>${order.birinciSinifMI}</td>
          <td>${order.birinciSinifDokum}</td>
          <td>${order.birinciSinifMiktar}</td>
          <td>${order.ikinciSinifMI}</td>
          <td>${order.ikinciSinifMiktar}</td>
          <td>${order.holdMiktar}</td>
          <td>${order.haddeBozgun}</td>
          <td>${order.hurdaMiktar}</td>
          <td>${order.malGrubu}</td>
          <td>${order.kalite}</td>
          <td>${order.cap}</td>
          <td>${order.dokumTipi}</td>
          <td>${order.planlanan}</td>
          <td>${order.gerceklestirme}</td>
        `;
        tbody.appendChild(row);
      });
    }

    /* --- KHH özet toplamları --- */
    function computeTotalsKHH(rows) {
      const sum = (k) => rows.reduce((a, r) => a + toFloat(r[k]), 0);
      return {
        gunlukUretim: sum('gunlukUretim'),
        s1Miktar: sum('birinciSinifMI'),
        s2Miktar: sum('ikinciSinifMI'),
        hurdaMiktar: sum('hurdaMiktar'),
        holdMiktar: sum('holdMiktar'),
        haddeBozgun: sum('haddeBozgun'),
        s1Dokum: sum('birinciSinifDokum')
      };
    }

    /* --- Özet panelini doldur --- */
    function renderSummaryBar(rows) {
      const wrap = document.getElementById('summary');
      const rangeEl = document.getElementById('summary-range');
      const chipsEl = document.getElementById('summary-chips');
      const barsEl = document.getElementById('summary-bars');

      if (!rows || !rows.length) { wrap.style.display = 'none'; return; }
      wrap.style.display = '';

      const qS = document.getElementById("fStart")?.value;
      const qE = document.getElementById("fEnd")?.value;

      const dates = rows.map(r => new Date(toISODateTR(r.tarih)));
      const minD = new Date(Math.min.apply(null, dates));
      const maxD = new Date(Math.max.apply(null, dates));
      const fmt = (d) => d.toLocaleDateString('tr-TR');

      const showS = qS ? new Date(qS) : minD;
      const showE = qE ? new Date(qE) : maxD;
      rangeEl.textContent = `${fmt(showS)} – ${fmt(showE)} aralığı için özet (KHH)`;

      const t = computeTotalsKHH(rows);

      chipsEl.innerHTML = '';
      [
        ["Günlük Üretim", t.gunlukUretim],
        ["1. Sınıf MI", t.s1Miktar],
        ["2. Sınıf MI", t.s2Miktar],
        ["Hurda", t.hurdaMiktar]
      ].forEach(([label, val]) => {
        const div = document.createElement('div');
        div.className = 'chip';
        div.innerHTML = `<span>${label}:</span> <b>${formatTon(val)}</b>`;
        chipsEl.appendChild(div);
      });

      const items = [
        { key: "gunlukUretim", title: "Günlük Üretim" },
        { key: "s1Miktar", title: "1. Sınıf MI" },
        { key: "s2Miktar", title: "2. Sınıf MI" },
        { key: "hurdaMiktar", title: "Hurda Miktarı" },
        { key: "holdMiktar", title: "Hold Miktarı" },
        { key: "haddeBozgun", title: "Hadde Bozgun" }
      ];
      const maxVal = Math.max(...items.map(i => t[i.key] || 0), 1);

      barsEl.innerHTML = '';
      items.forEach(i => {
        const val = t[i.key] || 0;
        const pct = Math.max(3, Math.min(100, Math.round((val / maxVal) * 100)));
        const card = document.createElement('div');
        card.className = 'bar-card';
        card.innerHTML = `
          <div class="bar-head">
            <div class="bar-title">${i.title}</div>
            <div class="bar-value">${formatTon(val)}</div>
          </div>
          <div class="bar"><span style="width:${pct}%"></span></div>
        `;
        barsEl.appendChild(card);
      });
    }

    /* --- Filtreler --- */
    function applyFilters() {
      const startDate = document.getElementById("fStart").value;    // yyyy-mm-dd
      const endDate = document.getElementById("fEnd").value;      // yyyy-mm-dd
      const malzemeQ = document.getElementById("fMalzeme").value.trim();
      const siparisQ = document.getElementById("fSiparis").value.trim();

      let out = detailOrders.slice();

      if (startDate) {
        const s = new Date(startDate);
        out = out.filter(o => new Date(toISODateTR(o.tarih)) >= s);
      }
      if (endDate) {
        const e = new Date(endDate);
        out = out.filter(o => new Date(toISODateTR(o.tarih)) <= e);
      }
      if (malzemeQ) {
        out = out.filter(o =>
          (o.malzeme && o.malzeme.includes(malzemeQ)) ||
          (o.tanim && o.tanim.toLowerCase().includes(malzemeQ.toLowerCase()))
        );
      }
      if (siparisQ) {
        out = out.filter(o => o.siparis && o.siparis.includes(siparisQ));
      }

      renderTable(out);
      renderSummaryBar(out);
    }

    /* --- Özet aç/kapa --- */
    function toggleSummary() {
      const summary = document.getElementById("summary");
      const btn = document.getElementById("toggleSummaryBtn");
      const isOpen = summary.classList.toggle("open");
      btn.textContent = isOpen ? "▲" : "▼";
      btn.classList.toggle("rotated", !isOpen);
    }

    /* --- Init --- */
    document.addEventListener("DOMContentLoaded", () => {
      renderTable(detailOrders);
      renderSummaryBar(detailOrders);
    });
  </script>
</body>

</html>